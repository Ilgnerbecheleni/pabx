<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;400;500;700&display=swap">
  <link rel="stylesheet" href="/css/suite.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
  <title>Suíte</title>
</head>
<body>
  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

  <aside class="sidebar">
    <nav class="sidebar__nav">
      <a class="icon active" href="#home"><ion-icon name="home-outline"></ion-icon></a>
      <a class="icon" href="#telephony"><ion-icon name="call"></ion-icon></a>
      <a class="icon" href="#devices-light"><ion-icon name="bulb-outline"></ion-icon></a>
      <a class="icon" href="#devices-air"><ion-icon name="snow-outline"></ion-icon></a>
      <a class="icon" href="#restaurant"><ion-icon name="restaurant-outline"></ion-icon></a>
    </nav>
  </aside>

  <main class="main">
    <div class="main__container">
      <section class="profile-section">
        <h2 class="profile-section__title">Motel Medieval</h2>
        <p class="profile-section__subtitle">Suíte Black</p>
      </section>

      <section class="section" id="telephony">
        <div class="section__header">
          <h3 class="section__title">Telefonia</h3>
        </div>
        <div class="contact-grid">
          <div class="contact-card">
            <h4 class="contact-card__title">Recepção</h4>
            <div class="contact-card__actions">
              <div class="action-button" id="btn--call-to-reception">
                <ion-icon name="call-outline"></ion-icon>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="modal modal--call" id="callModal">
    <div class="modal__container">
      <p class="modal__status" id="callStatus">Status da chamada: <span id="callerName">Nenhuma</span></p>
      <div class="modal__actions">
        <button class="modal__button--icon modal__button--accept" id="btnAcceptCall" style="display: none">
          <ion-icon name="call"></ion-icon>
        </button>
        <button class="modal__button--icon modal__button--end" id="btnEndCall" style="display: none">
          <ion-icon name="call"></ion-icon>
        </button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const localAudio = document.getElementById("localAudio");
    const remoteAudio = document.getElementById("remoteAudio");
    const callModal = document.getElementById("callModal");
    const callStatus = document.getElementById("callStatus");
    const btnAcceptCall = document.getElementById("btnAcceptCall");
    const btnEndCall = document.getElementById("btnEndCall");
    const callerName = document.getElementById("callerName");

    const pageRole = window.location.pathname.includes("lavanderia") ? "lavanderia" : "restaurante";
    socket.emit("register", pageRole);

    let currentTarget = null;
    let stream = null;
    let pc = createPeerConnection();

    function createPeerConnection() {
      const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      pc.ontrack = e => remoteAudio.srcObject = e.streams[0];
      pc.onicecandidate = e => {
        if (e.candidate && currentTarget) {
          socket.emit("signal", { to: currentTarget, data: { candidate: e.candidate } });
        }
      };
      return pc;
    }

    async function setupLocalStream() {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      localAudio.srcObject = stream;
    }

    socket.on("call", async ({ from }) => {
      currentTarget = from;
      callerName.textContent = `Recebendo chamada de ${from}`;
      callModal.classList.add("modal--visible");
      btnAcceptCall.style.display = "inline-block";
      btnEndCall.style.display = "inline-block";
    });

    socket.on("signal", async ({ from, data }) => {
      if (data.offer) {
        currentTarget = from;
        await setupLocalStream();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("signal", { to: from, data: { answer } });
      } else if (data.answer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    socket.on("end-call", () => {
      pc.close();
      pc = createPeerConnection();
      stream?.getTracks().forEach(track => track.stop());
      callerName.textContent = "Nenhuma";
      callModal.classList.remove("modal--visible");
    });

    btnAcceptCall.addEventListener("click", async () => {
      await setupLocalStream();
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("signal", { to: currentTarget, data: { answer } });
      callStatus.textContent = `Chamada em andamento com ${currentTarget}`;
      btnAcceptCall.style.display = "none";
    });

    btnEndCall.addEventListener("click", () => {
      socket.emit("end-call");
      pc.close();
      pc = createPeerConnection();
      stream?.getTracks().forEach(track => track.stop());
      callerName.textContent = "Nenhuma";
      callModal.classList.remove("modal--visible");
    });
  </script>
</body>
</html>
